<html lang="en"><HEAD>
<meta charset="utf-8" >
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" >
<link rel="stylesheet" href="../../assets/usage.css">
<TITLE>Resize Halo Bug -- ImageMagick Examples</TITLE>
<LINK REL="icon" HREF="../../img_www/favicon.ico" type="image/x-icon">
<LINK REL="shortcut" HREF="../../img_www/favicon.ico" type="image/x-icon">
<LINK REL="canonical"
      HREF="https://imagemagick.org/Usage/bugs/resize_halo/">
<!--[if gte IE 5.5000]><![if lt IE 7.0000]>
<script type="text/javascript" src="../../img_www/pngfix.js"></script>
<![endif]><![endif]-->
</HEAD><BODY BGCOLOR="#B0C4DE">

<H1>ImageMagick Examples -- <BR>
    <IMG SRC="../../img_www/space.gif" width=50 height=1>
    Resize Halo Bug -- FIXED</H1>

<div>

<DL>
<DT><B>Index</B>
<DT><A HREF="../../"
    ><IMG SRC="../../img_www/granitesm_left.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > ImageMagick Examples Preface and Index</A>
<DT><A HREF="../"
    ><IMG SRC="../../img_www/granitesm_left.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > Known and Fixed Bugs Index</A>
</DL>

This is a demonstration of a 'resize halo bug' generated by the resize filter
when doing small resizes of very light colored images on a transparent
background.  This bug was completely fixed, by user demand with the release of
ImageMagick version 6.2.4. </P>

This page is for reference for older IM users who may still have to deal with
this bug. The examples on this page have not been re-created when/if the bug
was fixed.  </P>

<HR><!-- ---------------------------------------------------------------- -->

<H2>Resize Halo Bug</H2>

We have a white text on a transparent background.  Everything works fine.

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background none -fill white -pointsize 72 -font Candice \
            label:Hello   label.png
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="label.png"
      ><IMG SRC="label.png"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

But resizing it slightly produces a slightly darker edge, though this is not
easily seen on the darker background of this page.

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background none -fill white -pointsize 72 -font Candice \
            label:Hello  -resize 95%  resized.png
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="resized.png"
      ><IMG SRC="resized.png"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

To see the halo clearly lets overlay the white text image on a white
background, then normalize to show the darker pixels.

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background none -fill white -pointsize 72 -font Candice \
            label:Hello  -resize 95% \
            -background white -flatten -normalize     resize_halo.jpg
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="resize_halo.jpg"
      ><IMG SRC="resize_halo.jpg"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

We can see that this really is a resize bug by removing the resize command
and overlaying, producing the expected pure white image.  A pure white image
should have been the result of the previous command.

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background none -fill white -pointsize 72 -font Candice \
            label:Hello  \
            -background white -flatten -normalize      no_resize.jpg
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="no_resize.jpg"
      ><IMG SRC="no_resize.jpg"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

<HR><!-- ---------------------------------------------------------------- -->

<H3>Non-Graphical Test for the Bug</H3>

Lets look at this in a different way.... </P>

Running the command...

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><PRE><CODE NO_EXECUTE>
    magick -background none -fill white -pointsize 72 -font Candice \
             label:Hello    txt:-  |\
      egrep -v '\) (white|none|#FFFFFFFFFFFF)'
</CODE>&nbsp;</PRE></TD></TR></TABLE>
</DIV></P>

The '<CODE>egrep</CODE>' will filter out any pixels in the "<CODE>txt:</CODE>"
output that are fully-transparent black or white, semi-transparent white
or fully-opaque white pixels.  This basically leave the "<CODE>txt:</CODE>"
comment header and any semi-transparent grey or black pixels, which form the
halo. </P>

In the above case their are no semi-transparent grey or black pixels, so only
the single line command header is generated. </P>

However if we now resize the image slightly before outputing the
"<CODE>txt:</CODE>" image file...

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><PRE><CODE NO_EXECUTE>
    magick -background none -fill white -pointsize 72 -font Candice \
            label:Hello   -resize 95%    txt:-  |\
      egrep -v '\) (white|none|#FFFFFFFFFFFF)'
</CODE>&nbsp;</PRE></TD></TR></TABLE>
</DIV></P>

You will now see lots, and lots, and lots, of semi-transparent grey pixels,
which should NOT have been generated!!!!   These pixels represent the 'black
halo' around the resized image. </P>

<HR><!-- ---------------------------------------------------------------- -->

<H3>A Work Around</H3>

The problem in the above is caused by the <A HREF="../../resize/#filters"
>resize filters</A> not understanding that full-transparent colors should not
be used in the final color of a pixel, only the transparency. </P>

This problem is the same problem involving blurs with transparency, and
discussed in <A HREF="../blur_trans/" >Blur Transparency Bug</A>,
and similar solutions to this problem also works here. </P>

One workaround that works on both problems, is to set the color of the
transparency to the same as the edge color of the image being resized.
That is, use a fully-transparent white (EG: '<CODE>#FFFF</CODE>' as the
background instead of fully transparent black (EG: '<CODE>none</CODE>'). 

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background '#FFFF' -fill white -pointsize 72 -font Candice \
            label:Hello   -resize 95%  resized_white.png
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="resized_white.png"
      ><IMG SRC="resized_white.png"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

For resize you can also try turn off the resize filters by using a
'<CODE>point</CODE>' resize filter. </P>

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background none -fill white -pointsize 72 -font Candice \
            label:Hello   -filter point  -resize 95%  resized_point.png
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="resized_point.png"
      ><IMG SRC="resized_point.png"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

And this works reasonably well for resizing small amounts, but falls down when
heavily resizing images.

<DIV ALIGN=center>
<table class="table table-sm table-hover" CELLSPACING=0 CELLPADDING=5 width="90%" bgcolor="#f8f8f8">
<TR><TD><pre class="bg-light text-dark mx-4"><samp>
    magick -background none -fill white -pointsize 1200 -font Candice \
            label:Hello   -filter point -resize 5%  resized_point_big.png
</CODE>&nbsp;</PRE></TD></TR></TABLE>
   <A HREF="resized_point_big.png"
      ><IMG SRC="resized_point_big.png"
            ALIGN=middle VSPACE=1 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

If you look closely at the result you can see that the image while not
having a resize halo effect, also effectively has no anti-aliasing along the
edges, (that is, it has the 'jaggies').  Also on more detailed images the
internal details of the resized image can be very bad indeed.  Even as small
resizes can produce a moire pattern across an image. </P>

Overlaying any of these examples on a white background (using -flatten for
example) and -normalizing will show no 'halo' effect. </P>

</DIV>
<HR><!-- ---------------------------------------------------------------- -->
<ADDRESS>
Created: 3 May 2005 <BR>
Updated: 10 August 2005 <BR>
Author: <A HREF="https://antofthy.gitlab.io/anthony.html"
        >Anthony Thyssen</A>, &lt;Anthony.Thyssen&#64;gmail.com&gt;<BR>
Examples Generated with:
        <IMG SRC="version.gif" ALIGN=absmiddle ALT="[version image]"><BR>
URL: <CODE>https://imagemagick.org/Usage/bugs/resize_halo/</CODE>
</ADDRESS></BODY></HTML>
