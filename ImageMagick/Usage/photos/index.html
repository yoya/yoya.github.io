<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.8.0">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../assets/usage.css">
  <title>Photo Handling -- ImageMagick Examples</title>
  <link rel="icon" href="../img_www/favicon.ico" type="image/x-icon">
  <link rel="shortcut" href="../img_www/favicon.ico" type="image/x-icon">
  <link rel="canonical" href="https://imagemagick.org/Usage/photos/">
</head>
<body>
  <main class="container">
    <div class="magick-template">
      <div class="magick-header">
        <h1>ImageMagick Examples --<br>
        <img src="../img_www/space.gif" width="50" height="1"> Digital Photo Handling</h1>
        <div>
          <dl>
            <dt><b>Index</b></dt>
            <dt>
              <a href="../"><img src="../img_www/granitesm_left.gif" border="0" width="15" height="15"> ImageMagick Examples Preface and Index</a>
            </dt>
            <dd>
              <a href="#exif"><img src="../img_www/granitesm_right.gif" border="0" width="15" height="15"> Digital Camera Meta-Data, the EXIF Profile</a>
            </dd>
            <dd>
              <a href="#orient"><img src="../img_www/granitesm_right.gif" border="0" width="15" height="15"> Digital Photo Orientation</a>
            </dd>
            <dd>
              <a href="#color"><img src="../img_www/granitesm_right.gif" border="0" width="15" height="15"> Color Improvements</a>
              <ul>
                <li>
                  <a href="#brightening">Brightening Under-exposed Photos</a>
                </li>
                <li>
                  <a href="#binning">Binning - Reducing Digital Noise</a> (Under Construction)
                </li>
              </ul>
            </dd>
            <dd>
              <a href="#cookbook"><img src="../img_www/granitesm_right.gif" border="0" width="15" height="15"> Photo Conversion Cookbook</a>
              <ul>
                <li>
                  <a href="#rotation">Minor Rotation Correction</a> <font size="-1">- fix a photo that is not quite level</font>
                </li>
                <li>
                  <a href="#tilt_shift">Tilt-Shift Effect</a> <font size="-1">- make scenery look like an artificial model</font>
                </li>
                <li>
                  <a href="#png_jpg">PNG-JPEG Layered Images</a> <font size="-1">- compressing pages while keeping text sharp</font>
                </li>
                <li>
                  <a href="#overlap">Overlapping Photos</a> <font size="-1">- blurred overlaps of appended photos</font>
                </li>
                <li>
                  <a href="#double">Double Exposures</a> <font size="-1">- mixing multiple photos of the same scene</font>
                </li>
                <li>
                  <a href="#anonymity">Protect Someone's Anonymity</a> <font size="-1">- fuzzing out some part of a photo</font>
                </li>
                <li>
                  <a href="#texture">Add a Texture to an Image</a>
                </li>
                <li>
                  <a href="#chroma_key">Chroma Key Masking</a> <font size="-1">- Modifying by areas of specific color</font>
                </li>
                <li>
                  <a href="#color-in">Children's Color-In Images</a>
                </li>
                <li>
                  <a href="#pencil">Pencil Sketch</a>
                </li>
                <li>
                  <a href="#vignettation">Vignette Removal</a>
                </li>
              </ul>
            </dd>
          </dl>One of the prime uses of ImageMagick is the handling and modification of photographs that were taken with the new modern digital camera. These cameras generally take quite large, high resolution photos, and include in them meta-data about the time, scale, zoom, camera, orientation, and so on. There are even plans to link cameras to mobile phones, so that it can even make a guess as to where you were when the photo was taken and who might be in the photo (from what mobile phones are in font of it). Here we look at the basics of handling digital photos, and even converting them for other purposes, such as artistic renderings. Special thanks goes to Walter Dnes, a digital camera user, for his help in the enhancement of digital photos.
          <hr>
          <!-- ---------------------------------------------------------------- -->
          <a name="exif" id="exif"></a>
          <h2>Digital Camera Meta-Data, the EXIF Profile</h2>When a digital camera takes a photo, it also includes a lot of extra information in the JPEG save file. This meta-data is known as the EXIF profile, and is provided specifically for photographic labs and development. The ImageMagick "<code>magick identify</code>" with a "<code><a href="../option_link.cgi?verbose">-verbose</a></code>" setting will display this Exif information. Here is the EXIF data of a photo I took of a <a href="../img_photos/pagoda_sm.jpg">Pagoda, Kunming Zoo, in Southern China</a>.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre><code execute="" noimage="" out="pagoda_sm_exif.txt">
  magick identify -format "%[EXIF:*]" pagoda_sm.jpg |\
      sed 's/\(.\{46\}\).*/\1/' | column -c 110
</code></pre>
                </td>
              </tr>
            </table>
            <table border="0" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <a href="pagoda_sm_exif.txt"><img src="pagoda_sm_exif.txt.gif" align="middle" vspace="0" hspace="0" border="0" alt="[IM Text]"></a>
                </td>
              </tr>
            </table>
          </div>
          <table border="0" cellspacing="0" cellpadding="0" width="90%" align="center">
            <tr valign="top">
              <td><img src="../img_www/warning.gif" width="28" height="28"><img src="../img_www/space.gif" width="12" height="16"></td>
              <td align="justify" width="100%"><font size="-1"><i>The EXIF data, or any identify output, should be processed in a case in-sensitive way. Many older versions of IM for example, will output "<code>EXIF:</code>" (uppercase) rather than "<code>exif:</code>" (lowercase).</i></font></td>
            </tr>
          </table>Here is a similar example but using 'globbing' (shell-like) expression to limit output to EXIF fields involving Time...
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre><code execute="" noimage="" out="pagoda_sm_time.txt">
  magick identify -format "%[exif:*time*]" pagoda_sm.jpg
</code></pre>
                </td>
              </tr>
            </table>
            <table border="0" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <a href="pagoda_sm_time.txt"><img src="pagoda_sm_time.txt.gif" align="middle" vspace="0" hspace="0" border="0" alt="[IM Text]"></a>
                </td>
              </tr>
            </table>
          </div>There is a lot of information about this photo in the EXIF profile. For example
          <ul>
            <li>My camera is a Panasonic ('<code>Make</code>'), DMC-LZ1 ('<code>Model</code>')</li>
            <li>The camera was rotated ('<code>Orientation</code>'). But I must have corrected that rotation without adjusting the EXIF data. The camera was also tilted upward slightly, but that info is not recorded.</li>
            <li>The '<code>FocalLength</code>' of '<code>37mm</code> shows that I did not make use of my cameras 'Optical Zoom' feature. My camera could go up to a 6X optical zoom for a '<code>FocalLength</code>' of '<code>366/10</code>' or '<code>222mm</code>'.</li>
            <li>And '<code>DigitalZoomRatio</code>' shows I did not digitally zoom either.</li>
            <li>The camera also used a fast 1/8 second '<code>ExposureTime</code>', and an aperture '<code>MaxApertureValue</code>' of 3mm, or '<code>FNumber</code>' of '<code>5.6</code>' and a '<code>ISOSpeedRating</code>' of '<code>64</code>'.</li>
            <li>The flash ('<code>LightSource</code>') was not used.</li>
            <li>The original image was 1728 by 2304 pixels ('<code>ExifImageLength</code>' and '<code>ExifImageWidth</code>'). Though the actual image, if you like to check is smaller, so I must have cropped and/or resized it.</li>
            <li>And probably most importantly, it was taken around 14:05pm on 9th of July 2005, according to the '<code>DateTime</code>' string. That assumes that I had the cameras time set correctly (which I did).</li>
            <li>More modern cameras may even have a GPS location and posibily a compass direction of the view!</li>
          </ul>Also included but not listed above is a small 'thumbnail' preview image that the camera used on its own display. There is also features to mark photos you want to be 'developed' or printed by photographic printers, and to adjust other printing parameters. However this is rarely used by most people. Many of these settings can be very useful to users, but the most useful to people is generally the date and time of the photo. This of course assumes that the date and time was set correctly on the cemera before the photo was taken. Also many people are interested in the orientation of the image so it can be rotated correctly when displayed, and That is, what we'll look at next. All this data, and especially the preview image, can take up quite a lot of space in the image. And it may be that I don't actually want everyone in the world knowing that I was in Kunming, China in July 2005. As such you may like to remove EXIF data from your images before actually publishing it on the World Wide Web. Also the size of an image from a digital camera usually very large (and getting larger), allowing you to print it at photo quality level, but is far too large for use of the WWW, and especially not for thumbnails. As such unless you want users to actually be able to print photo quality images, I would not publish the original image directly. The above image for example has been cropped and resized for IM examples usage, but I purposely left the EXIF data intact for the example. Normally I would strip this information.
          <hr>
          <!-- ---------------------------------------------------------------- -->
          <a name="fix" id="fix"></a> <a name="orient" id="orient"></a>
          <h2>Digital Photo Orientation</h2>I have been told that Photoshop will automatically rotate digital images based on the EXIF '<code>Orientation</code>' setting, IM will also do this by including a "<code><a href="../option_link.cgi?auto-orient">-auto-orient</a></code>" operator, after reading in the image. However, and this is important
          <div align="center">
            <b>JPEG Format is Lossy</b>
          </div>What this means is that any time you decode and save the JPEG file format you will degrade the image slightly. As a general image processor, IM will always completely decode and re-encode the format, as such it will always degrade JPEG images when it re-saves the image. For more information on the nature of the JPEG format see <a href="../formats/#jpg">JPEG Image File Format</a>. The point is to only use IM to correct digital photo orientation (using "<code><a href="../option_link.cgi?auto-orient">-auto-orient</a></code>") when you are also performing other image modifying operations, such as <a href="../thumbnails/#creation">Thumbnail Creation</a>, <a href="../annotating/#anno_on">Annotating Images</a>, <a href="../annotating/#watermarking">Watermarking</a> or even <a href="#brightening">Exposure Adjustments</a>. IM can extract the current orientation (as a number) from the photo using an <a href="https://imagemagick.org/script/escape.php">Image Property Escape</a>...
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="center">
              <td width="10%" align="justify" rowspan="2"></td>
              <td width="90%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre><code execute="" noimage="" out="orient_show.txt">
  magick identify -format '%[exif:orientation]' pagoda_sm.jpg
</code></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td width="10%">
                <a href="orient_show.txt"><img src="orient_show.txt.gif" align="middle" vspace="0" hspace="20" border="0" alt="[IM Text]"></a>
              </td>
            </tr>
          </table><!--  THIS FAILS.  If you save it and then look at the result.

You can also set the EXIF value directly (caution is required as no format
checks are performed).

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%">
<TR VALIGN=center><TD WIDTH=10% ALIGN=justify ROWSPAN=2></TD>
                  <TD width="90%" ALIGN=justify>
<table class="table table-sm table-hover table-striped" CELLSPACING=0 CELLPADDING=5 width="100%" bgcolor="#f8f8f8">
<TR><TD><PRE><CODE _EXECUTE NOIMAGE OUT=orient_set.txt>
  magick pagoda_sm.jpg -set exif:orientation 5 \
                  -format '%[exif:orientation]'   info:
</samp></pre></TD></TR></TABLE></TD><TD WIDTH=10%>
  <A HREF="orient_set.txt"
      ><IMG SRC="orient_set.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=20 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE></P>
-->
          IM provides a special "<code><a href="../option_link.cgi?orient">-orient</a></code>" operator (use "<code><a href="../option_link.cgi?list">-list</a> orientation</code>" to see possible values).
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="center">
              <td width="10%" align="justify" rowspan="2"></td>
              <td width="90%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre><code execute="" noimage="" out="orient_setting.txt">
  magick pagoda_sm.jpg -orient bottom-right \
                 -format '%[exif:orientation]'   info:
</code></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td width="10%">
                <a href="orient_setting.txt"><img src="orient_setting.txt.gif" align="middle" vspace="0" hspace="20" border="0" alt="[IM Text]"></a>
              </td>
            </tr>
          </table>These meta-data setting methods, allow you to adjust the orientation of photos you have modified, especially ones you have rotated. Note that a correctly orientated photo has an orientation of '<code>Top-Left</code>' or 1. Of course you should not remove the EXIF meta-data (using either "<code><a href="../option_link.cgi?strip">-strip</a></code>" or "<code><a href="../option_link.cgi?thumbnail">-thumbnail</a></code>"), if you plan to use "<code><a href="../option_link.cgi?auto-orient">-auto-orient</a></code>" later in the image processing. Use it before stripping the image meta-data. If you do want to correct the orientation of your photo, without degrading or otherwise modifying your image, I suggest you use the <a href="http://www.sentex.net/~mwandel/jhead/">JHead</a> program. For example here I correct a photos orientation, and delete the built-in preview thumbnail all the digital photos in a directory.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  jhead -autorot  *.jpg
</samp></pre>
                </td>
              </tr>
            </table>
          </div>
          <table border="0" cellspacing="0" cellpadding="0" width="90%" align="center">
            <tr valign="top">
              <td><img src="../img_www/warning.gif" width="28" height="28"><img src="../img_www/space.gif" width="12" height="16"></td>
              <td align="justify" width="100%"><font size="-1"><i>The JPEG lossless rotation will only work correctly for images that have a size that is divisible by 8 or 16. This is true with most (but not all) digital camera photos. If you try this with an image that is an odd size the right or bottom edge blocks (containing the partial size) will not be positioned correctly in the final image, as these block can only exist on the right or bottom edge.<br>
              <br>
              For an example of this see this <a href="../forum_link.cgi?t=16784&amp;p=62157">specific discussion</a></i></font></td>
            </tr>
          </table>The <a href="http://www.sentex.net/~mwandel/jhead/">JHead</a> program will also let you adjust the photos date (if your camera time was set wrong, or you have travelled to different time zones), extract/remove/replace the preview thumbnail, set the comment field of the image, remove photoshop profiles, and do basic image cropping (to remove that stranger exposing himself ;-) so on, without degrading the JPEG image data. I recommend this program, or other programs like it (see <a href="../formats/#jpg_non-im">Other JPEG Processing Programs</a>), to fix this information. Just be sure that it does not actually decode/re-encode the JPEG image data. One final point about orientation. If you pointed your camera almost straight up or down, the EXIF orientation setting may not resolve correctly. The same goes for angled or slanted shots. The orientation (and cameras) just have no senses for these situations. Your only choice for such photos is to do the rotates yourself using the lower level non-lossy "<code>jpegtrans</code>", or IM "<code><a href="../option_link.cgi?rotate">-rotate</a></code>", and then either reset the EXIF orientation setting (using <a href="http://www.sentex.net/~mwandel/jhead/">JHead</a> or the IM "<code><a href="../option_link.cgi?orient">-orient</a></code>" operator), or just strip the EXIF profile.
          <pre>
Other IM Lossy Modifications...
  If you are also resizing or otherwise modifying the image, such as reducing
  its quality and size for use on the web, then data loss is already a fact.
  As such during those operations IM can do similar things, allowing you to do
  all the required operations in a single 'load-save' cycle.

  Rotate ALL images to landscape   -rotate 90\&lt;
                       portrait    -rotate -90\&gt;

</pre>
          <hr>
          <!-- ---------------------------------------------------------------- -->
          <a name="color" id="color"></a>
          <h2>Color Improvements</h2>Before proceeding, it is recommended that you first look at <a href="../color_mods/">Color Modifications</a> for an introduction to general color modification techniques that will be used. <a href="../color_mods/#normalize">Normalizing</a> (using "<code><a href="../option_link.cgi?normalize">-normalize</a></code>") high-contrast line art and graphics can be great. But normalized photos may look unreal, and, as was said earlier, may not print well either. The "<code><a href="../option_link.cgi?contrast-stretch">-contrast-stretch</a></code>" operator can limit the "boundaries" of the normalization, but the "<code><a href="../option_link.cgi?levels">-levels</a></code>" and/or "<code><a href="../option_link.cgi?sigmoidal-contrast">-sigmoidal-contrast</a></code>" operator can make "smoother" adjustments (see <a href="../color_mods/#histogram">Histogram Adjustments</a> for a lower level discussion of what these operators do). The above input is courtesy of "Tong" form the IM Mailing List. <a name="brightening" id="brightening"></a>
          <h3>Brightening Under-exposed Photos <font size="-2">Contributed by Walter Dnes</font></h3>Sometimes there simply isn't enough available light to allow for a proper exposure. At other times, you may have to use shorter exposure times than optimal, in order to eliminate motion-blur. Underexposed digital photos can have darker areas preferentially brightened, without blowing highlights, by using the "<code><a href="../option_link.cgi?sigmoidal-contrast">-sigmoidal-contrast</a></code>" operator, with a '<code>0%</code>' threshold level. See <a href="../color_mods/#sigmoidal">Sigmoidal Non-linearity Contrast</a> for more details. Here is a minor underexposure example, which was taken at a free concert after sunset. This has lots of brightly lit areas, which are clear, but also dark areas I would like to make more visible.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick night_club_orig.jpg  -sigmoidal-contrast 4,0%  night_club_fixed.jpg
</samp></pre>
                </td>
              </tr>
            </table><!-- <CODE EXECUTE NOIMAGE>
  magick mogrify -format gif -thumbnail 120x90 +repage night_club_fixed.jpg
</CODE> -->
            <a href="../img_photos/night_club_orig.jpg"><img src="../img_photos/night_club_tn.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="night_club_fixed.jpg"><img src="night_club_fixed.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>
          <table border="0" cellspacing="0" cellpadding="0" width="90%">
            <tr valign="top">
              <td><img src="../img_www/reminder.gif" width="20" height="16"><img src="../img_www/space.gif" width="20" height="16"></td>
              <td align="justify" width="100%"><font size="-1"><i>As always, you should use a non-lossy format like TIFF or PNG for intermediate work. The JPEG format is only used here to reduce disk space and download bandwidth for web publishing.<br>
              <br>
              Select image to see the enlarged version actually used by the examples rather than the small thumbnail shown.</i></font></td>
            </tr>
          </table>And here is a major underexposed example, which was a night-time shot from my balcony looking southwards towards the city of Toronto.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick night_scape_orig.jpg -sigmoidal-contrast 10,0%  night_scape_fixed.jpg
</samp></pre>
                </td>
              </tr>
            </table><!-- <CODE EXECUTE NOIMAGE>
    magick mogrify -format gif -thumbnail 120x90 +repage night_scape_fixed.jpg
</CODE> -->
            <a href="../img_photos/night_scape_orig.jpg"><img src="../img_photos/night_scape_tn.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="night_scape_fixed.jpg"><img src="night_scape_fixed.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>The main parameter controls the amount of brightening. The more brightening required the higher value used. And the grainier the output picture will look. This is due to the smaller pixel errors also being enhanced. Sigmoidal contrast brightening tends to de-emphasize the red end of the spectrum. You may end up having to select a parameter that results in the most natural flesh tones, rather than the brightness level you really want. In the case of major underexposure, you will end up with a glorified grainy black-and-white image after brightening. This is a physical limitation of digital image enhancement. If there's no colour data present, IM won't generate it for you. In real life the bricks on the right-hand side of my balcony are reddish, and the trees below are green. <a name="binning" id="binning"></a>
          <h3>Binning -- Reducing Digital Noise <font size="-2">Contributed by Walter Dnes</font></h3>A lot of serious photographers are unhappy with the side-effects of the "megapixel race" by digital camera manufacturers. Manufacturers pack more megapixels into a digital camera's sensor by making them smaller. Smaller pixels result in a noisier picture at the same ISO setting, which forces people to use lower ISO settings. Using lower ISO ratings to avoid noise requires longer exposure times. This, in turn, means that most consumer digital cameras are effectively useless indoors beyond the 10-foot range of their built-in flash for anything except a still-life picture taken with the camera on a tripod. Many digital camera users would gladly trade some pixels for less noisy pictures at higher ISO settings, but the marketeers who control the companies refuse to consider this as an option. Fortunately, the trade-off can be done after the fact on digital photos. The technical term is 'binning'. The simplified theory goes like so...
          <ul>
            <li>Take an n-by-n grid of pixels, and average their components to obtain one "super-pixel".</li>
            <li>Signal is proportional to the combined pixel area, which means that the amount of signal has increased by a factor of n^2</li>
            <li>Noise is random. Which means that it is proportional to the square root of the combined pixel area, a factor of n. The net result is that SNR (signal-to-noise ratio) has increased by a factor of n. See <a href="http://www.noao.edu/outreach/aop/glossary/binning.html">Photo Glossary, Binning</a> for more details.
            </li>
          </ul>When a 1600x1200 digital photo is binned down to 800x600 (i.e. a 2x2 grid) the signal-to-noise ratio is doubled. Similarly, a 2560x1920 picture binned 3x3 to 853x640 pixels will have a factor of 3 improvement in signal-to-noise ratio.
          <table border="0" cellspacing="0" cellpadding="0" width="90%">
            <tr valign="top">
              <td><img src="../img_www/reminder.gif" width="20" height="16"><img src="../img_www/space.gif" width="20" height="16"></td>
              <td align="justify" width="100%"><font size="-1"><i>In order to make use of binning, the photo image must be a whole number multiple of the final desired size.</i></font></td>
            </tr>
          </table>In ImageMagick, the special "<code><a href="../option_link.cgi?filter">-filter</a></code>" setting '<code>box</code>' will average groups of pixels down to a single pixel when you "<code><a href="../option_link.cgi?resize">-resize</a></code>" an image (See <a href="../filter/#filter">Resampling Filters</a> for details. This means that to do a 'binning' you only need to resize the image correctly.
          <div align="center">
            <font size="+2"><b><img src="../img_www/const_barrier.gif" width="39" height="35" align="top"> Under Construction <img src="../img_www/const_hole.gif" width="144" height="50" align="middle"></b></font>
          </div>Walter Dnes also provided the original script <a href="binning/binn">binn</a> to perform the calculations, minimally crop the image and perform the 'binning'. <a href="binning/sample3.html">Binning examples 3</a><a href="binning/sample4.html">Binning examples 4</a>
          <hr>
          <!-- ---------------------------------------------------------------- -->
          <a name="cookbook" id="cookbook"></a>
          <h2>Photo Conversion Cookbook</h2><a name="rotation" id="rotation"></a>
          <h3>Minor Rotation Correction <font size="-1">-- Make a photo more level</font></h3>Typical situation. You have taken a photo, but the image isn't level, and you want to correct it. <a href="../img_photos/beijing_md.jpg"><img src="beijing_tn.png" align="right" vspace="0" hspace="5" border="1" alt="[IM Output]"></a><!-- <CODE EXECUTE>
  magick beijing_md.jpg -thumbnail x150 beijing_tn.png
</CODE> -->
          For example, here is a photo I took using a hand held camera in Beijing, 2008, from the hill in Jingshan Park, immediately behind the Forbidden City. No it isn't of the Forbidden City itself, but a temple on the other side of the hill. <i>Click on the thumbnail, to see a larger image.</i> Yes the image is small, and you should apply the solution to the original image not a small thumbnail, but the techniques is the same for any image. In this case the image needs to be rotated by -1.8 degrees, to correct it.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                Now if you just simply rotate the image you will get a slightly larger image containing areas of color in the corners, making the correction look obvious and horible.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick beijing_tn.png -rotate -1.95  beijing_rotate.png
</samp></pre>
                    </td>
                  </tr>
                </table>Even if you were to crop the image back to its original size, such as demonstarted in <a href="../warping/#rotate">Simple Image Rotations</a> you will still get some colored corners.
              </td>
              <td>
                <a href="beijing_rotate.png"><img src="beijing_rotate.png" align="middle" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>The simplist solution would be to now crop that result so as to remove those borders, but then your image becomes a rather odd size, which is again rather obvious that something has been done. Though the formula to do that clipping is not simple, but is demonstrated in <a href="../distorts/#rotate_methods">Distortion Rotation Methods</a>.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                The better solution is to not only rotate the image, but scale it slightly so as to produce a rotated image that is the same size as the original.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  angle=-1.95
  magick beijing_tn.png -distort SRT \
     "%[fx:aa=$angle*pi/180;(w*abs(sin(aa))+h*abs(cos(aa)))/min(w,h)], $angle" \
     beijing_rot_correction.png
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="beijing_rot_correction.png"><img src="beijing_rot_correction.png" align="middle" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>And the image is clean looking with a perfectly level wall. The angle calculation is reasonably straight forward trigonometry, using the pixel locations at the ends of a long straight line in the image. However I found that simply rotating the image at various small angles by trial and error will find a good rotation angle relatively quickly. When looking how good a particular angle is, take a very close zoomed in look at the pixels along the line or edge you using. The top of the wall in this photo. And remember in image rotations a left or anti-clockwise rotation is negative (due to Y-axis pointing downward). Also remember that if at all possible, always apply operations to the original image, avoiding the use intermediate images (and especially intermediate JPEG images). It is always better to apply any photo modification starting with the original source than any saved intermediate copy. <a name="tilt_shift" id="tilt_shift"></a>
          <h3>Tilt-Shift Effect <font size="-1">-- make scenery look like an artificial model</font></h3><a href="../img_photos/beijing_md.jpg"><img src="beijing_tn.png" align="right" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>The 'Tilt-Shift' is a technique which causes an image be be blurred at the top and bottom, while leaving the center of the image unblurred. It was originally done in very old bellow type cameras where the lens was tilted to bring the top and bottom of the image out of focus. Thanks of the introduction of <a href="../mapping/#blur">Variable Blur Mapping</a>, added to ImageMagick in v6.5.4-0 this is now easy to do. If you add to this a very high contrast so as to enhance shadows, and saturate the colors, a typical result is that a normal image can be made to look artificial. Almost as if you were taking a photo of a small, highly detailed, and brightly lit, model.<br clear="all">
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                The first thing we need to do, is enhance the colors in the image to give it a very high contrast, and perhaps brighten it a bit to make it look like it is very well lit with strong studio lights.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick beijing_md.jpg -sigmoidal-contrast 15x30% beijing_contrast.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="beijing_contrast.jpg"><img src="beijing_contrast_tn.gif" align="middle" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table><!-- <CODE EXECUTE>
  magick beijing_contrast.jpg -thumbnail x150 beijing_contrast_tn.gif
</CODE> -->
          Note how I used a strong <a href="../color_mods/#sigmoidal-contrast">Sigmodial Contrast Operation</a>, to achieve these color effects. I did not just simply use a linear contrast as I did not want to 'clip' the brightest and darkest colors of the image. The contrasting value of '<code>15</code>' is a very very strong contrast. I also brightened the image a bit by offsetting the center of the contrast threshold to a '<code>30%</code>' gray value. If the colors of the contrast enhanced image does not come out cartoonish enough, you may like to try increasing the color saturation of the image, using the <a href="../color_mods/#modulate">Modulate Operator</a>. This image did not need it as it as the tiled roof and bright green trees already provides enough color effects. If you look at an enlargement of the image (<i>Click on the thumbnail</i>), you will see that even just enhancing colors gives the image a feel of artificial lights, though it does not look like a model, with too much detail to the cars in the background, and people in the foreground.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                Now for the tilt-shift. For this we prepare a gradient image that is white at the top and bottom, and black in the middle. Some people might use a linear gradient for this, but I find a parabolic gradient better.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick beijing_contrast.jpg \
          -sparse-color Barycentric '0,0 black 0,%h white' \
          -function polynomial 4,-4,1   beijing_blurmap.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="beijing_blurmap.jpg"><img src="beijing_blurmap_tn.gif" align="middle" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table><!-- <CODE EXECUTE>
  magick beijing_blurmap.jpg -thumbnail x150 beijing_blurmap_tn.gif
</CODE> -->
          Note that I used the original image itself with a two point <a href="../canvas/#barycentric">Barycentric Sparse Coloring</a> to generate a linear gradient over the whole image. That linear gradient is then modified using a basic <a href="../transform/#function_polynomial">Polynomial Function</a> to make it a parabolic gradient with black in the middle. Now it is simply a matter of blurring the image according to the blur map to create a 'tilt-shift' effect. The result is that the original image looks rather like a scale model, rather than quick snap-shot of the real thing.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick beijing_contrast.jpg  beijing_blurmap.jpg \
          -compose Blur -set option:compose:args 10 -composite \
          beijing_model.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="beijing_model.jpg"><img src="beijing_model.jpg" align="middle" vspace="2" hspace="5" border="1" alt="[IM Output]"></a>
          </div>As you can see in the final image, the trees and the buildings look very artificial, due to the strong colors, while the blurring of the near and far parts gives the image a 'small' model-like feel to it. Though this must have been a very detailed model! The result could have been improved further by performing a <a href="#rotation">Rotation Correction</a> (see previous) as part of the tilt shift processing. A perfect camera orientation would simply added to the artificial feel. Of course you can string all these operations together to to it all in one command, and avoid temporary files, or loss of quality.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick beijing_md.jpg -sigmoidal-contrast 15x30% \
          \( +clone -sparse-color Barycentric '0,0 black 0,%h gray80' \
             -solarize 50% -level 50%,0 \) \
          -compose Blur -set option:compose:args 10 -composite \
          beijing_model.jpg
</samp></pre>
                </td>
              </tr>
            </table>
          </div>In the above I replaced the parabolic gradient with a more traditional linear black-white-gray gradient (with the same slope) to the 'tilt-shift' blur map. The <a href="../color_mods/#solarize">Solarize & Level</a> technique was used to make the linear gradient peak horizontally about 1/3 from the bottom of the image. However I find that the area of focus in a linear gradient too small and not very practical. There are many other way of generating a suitable gradient for a tilt shift effect. For example using <a href="../canvas/#gradient_resize">Resized Gradients</a>. Or horizontally scaling a <a href="../canvas/#shepards">Shepards Sparse Color</a> of single column of pixels. Sine curve gradients may also be useful.
          <h5>Speed Optimization</h5>The <a href="../mapping/#blur">Variable Blur Mapping</a> operation is essentually using a single pass 2-dimentional blurring method (equivelent to an uniform Gaussaian Blur). However you can get a general speed boost by doing the bluring operation in two 1-dimensional variable blur operations. For example, here I first blur horizontaly, the vertially...
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick beijing_md.jpg -sigmoidal-contrast 15x30% \
          \( +clone -sparse-color Barycentric '0,0 black 0,%h gray80' \
             -solarize 50% -level 50%,0 -write mpr:blur_map \) \
          -compose Blur -set option:compose:args 10x0 -composite \
          mpr:blur_map \
          -compose Blur -set option:compose:args 0x10 -composite \
          beijing_model_2pass.jpg
</samp></pre>
                </td>
              </tr>
            </table>
          </div>The result is practially identical (though does differ somewhat), but is a lot faster to process. ASIDE: I believe that swaping the operations (blur vertical then horizontally) will generate a more accurite result for this type of blur mapping. basically as the horizontal blur is a constant in the direction of that blur pas, so should be done last.
          <h5>Problems with Tilt-Shift Effect vs A Real Model</h5>If you examine the resulting photo carefully, you will be able to tell it is a fake tilt-shift, and not a photo of a real model. You can see this in that the roof of the larger building is too blurry when compared to the base of the building. Even though it is about the same distance as the base. Similarly the base of the 'wall' is more blurry than the top of the wall. That is, it can be seen to be a fake. The problem is that large vertical objects, should be blurred by the same amount over the whole surface, and not just variably blurred by height. Remember the blur gradient is meant to represent the focal depth, or distance of the various objects in the image, as such the surface of a vertical object should all be the same 'distance' and thus blurred by the same amount. To fix I would need to adjust the blur gradient to make those areas have a with a constant (or near constant) color of the 'base' of that object, relative to rest of the image. That is, vertical surfaces have a constant blur amount while all the horizontal surfaces have a blur gradient. Basically the blurred gradient should represent the actual 'depth' of each point in the image, which for most images is a very complex gradient. This adjustment can be difficult to achieve, as it most likely requires some human interpretation of what is a horizontal wall and how far the object is in the image. It is also unlikely to be easily automated. What can you do with this effect? Mail me your tilt-shift images! I'll reference them here. Or perhaps you can correct the tilt-shift faults in the above example. <a name="png_jpg" id="png_jpg"></a>
          <h3>PNG-JPEG Layered Images</h3>By separating a large newspaper or magazine page into a text layer that is saved as a PNG, and an image layer saved as JPG, both using just a white background, it is possible to use much less disk space than the two images combined! More importantally images can use a lossy compression (JPEG), the text components will remain sharp an clear (PNG). It sounds silly and weird but it is actually true. The separated images can save 3 to 4 times the disk space used by a single combined image. Usually the two images are generated during the publication process as separate layers. But you can also separate images after the fact too. The images are just overlayed together...
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick ny_family.jpg ny_family.png -composite   ny_family_merged.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/ny_family.jpg"><img src="../img_photos/ny_family_tn.jpg" align="middle" vspace="5" hspace="15" border="1" alt="[IM Output]"></a> <img src="../img_www/multiply.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="../img_photos/ny_family.png"><img src="../img_photos/ny_family_tn.png" align="middle" vspace="5" hspace="15" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="ny_family_merged.jpg"><img src="ny_family_merged_tn.jpg" align="middle" vspace="5" hspace="15" border="1" alt="[IM Output]"></a><br>
            <font size="-1">Select the resulting images to see a larger copy.</font>
          </div><!-- <CODE EXECUTE>
  magick ny_family_merged.jpg -thumbnail x100 ny_family_merged_tn.jpg
</CODE> -->
          This uses a normal <a href="../compose/#over">Over Composition</a>, which requires the PNG (overlay) image to be transparent. This transparency comes in two forms. Either as a boolean (pure on/off) mask, such as seen in the above. Example code for image separation welcome. <a name="overlap" id="overlap"></a>
          <h3>Overlapping Photos <font size="-1">-- blurred overlaps of appended photos</font></h3>Creating a series of overlapping photos (and I don't mean a panarama) is a common task, especially in web site creation. But is can be tricky to do unless you have the right knowledge of IM operators. The simplest method is to use a <a href="../compose/#mask">Masked Composite</a> of the two images, and a mask to select which image to overlay. First however you need to do simple mathematics. For this example, I am using two thumbnail images 120x90 pixels in size and I want to overlap them horizontally by 40 pixels. This means the resulting image should be 120 + 120 - 40 pixels wide, or a 200x90 pixel image. Next we need a mask. This needs to black one one side, white on the other, with a 40 pixel gradient in the middle, the size of the final output image. That is, 120 pixels - 40 pixel gives an 80 pixel area for each of the two non-overlapped areas. So lets generate a masking image...
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick -size 90x80 xc:white xc:black   -size 90x40 gradient: \
          +swap -append -rotate 90    overlap_mask.png
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="overlap_mask.png"><img src="overlap_mask.png" width="200" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>An alternative way of generating the masking image is to use Fred Weinhaus's "<code><a href="http://www.fmwconcepts.com/imagemagick/plmlut/index.php">plmlut</a></code>" horizontal gradient generator script. This has finer controls for the curvature of the gradient rather than a sharp linear gradient I generate above. Now that all of the math is out of the way, all that is left is to do a three image masked composition, using the mask we just generated. However we will also need to enlarge the destination (left) image so as to provide enough space for the overlapping right image (any color), and position the second image correctly using the appropriate gravity (right, or '<code>East</code>').
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick holocaust_tn.gif -extent 200x90  spiral_stairs_tn.gif \
          overlap_mask.png  -gravity East -composite   overlap_photos.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/holocaust_tn.gif"><img src="../img_photos/holocaust_tn.gif" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <a href="../img_photos/spiral_stairs_tn.gif"><img src="../img_photos/spiral_stairs_tn.gif" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/plus.gif" align="middle" width="20" height="20" alt=" + "> <a href="overlap_mask.png"><img src="overlap_mask.png" width="200" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="overlap_photos.jpg"><img src="overlap_photos.jpg" width="200" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>And we now have two images, which are overlapped using a linear gradient. Of course the two commands can be merged into a single command, so that you don't need to save the 'mask' intermediate image. This is left as an exercise to the reader. A slight improvement is to use a more curved gradient over a larger overlap between the images. This reduces the sharp change visible at the start and end of the overlap area of the final image. Especially with images contain large areas of very different colors. For example, this uses some <a href="../canvas/#gradient_distort">Distorted Gradient</a> techniques to not only generate a smoother gradient curve, but also to rotate that gradient so as to have a highly angled overlap.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick -page +0-15 -size 1x30 gradient: \
          -sigmoidal-contrast 5,50% -contrast-stretch 0 \
          -set option:distort:viewport 180x90-90-45 \
          +distort SRT 115 +repage \
          holocaust_tn.gif -extent 180x90 +swap \
          spiral_stairs_tn.gif +swap \
          -gravity East -composite   overlap_angled.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="overlap_angled.jpg"><img src="overlap_angled.jpg" width="160" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>Yes, the above is rather complex, but it shows just what is possible. If you plan to do more than two images, a better method is to use the mask to directly set the transparency of the second and later images. The multiple images can then be overlaid together using a techniques seen in <a href="../layers/#layer_prog">Layered Image Examples</a>. Some of these techniques do not require you calculate the final image size, as IM can do this for you. You only need to make sure you position the images correctly. For example, here I add a 30 pixel gradient to a second and third image, requiring the images to be placed every 90 pixels (width 120 minus 30 pixel overlap) from each other. When all images are given the appropriate transparency and positioning, we just <a href="../layers/#mosaic">Mosaic</a> the layers together (all offsets are positive), letting IM figure out the final canvas size.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick -size 90x90 xc:white -size 90x30 gradient: -append -rotate 90 \
          hatching_tn.gif \
          \( chinese_chess_tn.gif -clone 0 \
                 -compose CopyOpacity -alpha off -composite -repage +90+0 \) \
          \( holocaust_tn.gif -clone 0 \
                 -compose CopyOpacity -alpha off -composite -repage +180+0  \) \
          \( spiral_stairs_tn.gif -clone 0 \
                 -compose CopyOpacity -alpha off -composite -repage +270+0 \) \
          -delete 0   -compose Over  -mosaic     overlap_series.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="overlap_series.jpg"><img src="overlap_series.jpg" width="390" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>Rather than pre-calculating the positions of the overlapping masked images, you can use techniques found in <a href="../layers/#append_overlap">Append Overlap</a>, as well as <a href="../layers/#layer_calc_inc">Incrementally Calculated Positions</a> for longer image sequences. <b>Final Notes:</b> Overlapping photos like this works best for images with a reasonably common overall color. Also you may notice that for the images at either end of the sequence, a centered subject may not look very centered due to the overlap on one side of the image only. This problem can be improved either by fading the outside edge of those images into transparency, or chopping of some of outside edge to help re-center the subject of those images. <i><code>ASIDE: It may be that doing the composition in a different colorspace may work better. Anyone like to experiment and report on your results, good or bad?</code></i> <a name="double" id="double"></a>
          <h3>Double Exposures <font size="-1">-- mixing multiple photos of the same scene</font></h3>With old time film based cameras, there was a technique where a picture was take two or more times without 'rolling' the film. This allowed you to create what was known as double exposures, where two images taken at slightly different times were merged together. The result was often a ghosting or dimming of parts of the image which moved or changed. However with careful control of the subjects in the image, the lighting effects, and even the development process, it became possible to make some very weird or even 'impossible' photos. With digital images it is even easier as you have even better control of the images. Basically... <i>Seeing may be believing, but cameras lie!</i> For example suppose I wanted an image in which I appear in twice! Well that is easy to do. Here for example are the thumbnails of two quick photos I took specifically for this example, using a tripod and timer, which I'll use directly.
          <div align="center">
            <a href="../img_photos/anthony_1.jpg"><img src="../img_photos/anthony_1.jpg" width="100" height="90" align="middle" vspace="5" hspace="25" border="1" alt="[IM Output]"></a> <a href="../img_photos/anthony_2.jpg"><img src="../img_photos/anthony_2.jpg" width="100" height="90" align="middle" vspace="5" hspace="25" border="1" alt="[IM Output]"></a><br>
            <i>Perhaps you can supply a better more amusing photo set?</i>
          </div>I will apply the double exposure techniques directly to these thumbnails, though more typically I would do this using original image files as inputs, so as to get a result of the highest quality. Now if I used a traditional film-like 'double exposure' with an old style camera, the result would be an average of these two images, generating see-thru 'ghosts' of myself. Here is the digital simulation of this technique...
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick anthony_1.jpg anthony_2.jpg -evaluate-sequence mean  anthony_ghosts.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="anthony_ghosts.jpg"><img src="anthony_ghosts.jpg" width="100" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>However, what if I don't want ghosts, but properly solid images of myself. Well then you need to use a mask to select which parts you want to come from which image. This mask can be generated in two ways. You can just manually create the mask by dividing the image along the static or unchanging parts. A rather simple matter in this particular case...
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick -size 100x90 xc: -draw 'rectangle 0,0 50,89' \
          -blur 0x3  anthony_mask.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="anthony_mask.jpg"><img src="anthony_mask.jpg" width="100" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>Note that I blurred the mask, so as to 'feather' the cut-over between the two images. And here I use a <a href="../compose/#mask">Masked Composition</a> to merge the images.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick anthony_1.jpg anthony_2.jpg anthony_mask.jpg \
          -composite  anthony_doubled.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="anthony_doubled.jpg"><img src="anthony_doubled.jpg" width="100" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>How if you had two (or more) family photos, where some people had eyes closed, were speaking, pulling faces, or just looking away. You could pick and choose each 'head' from different images and merge the multiple images to form a montage, so as to get a photo where everyone is looking at the camera, and have their eyes open. By swapping the input images, or just negating the mask, you can remove me completely from the image, so get an unrestricted view of the static background.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick anthony_2.jpg anthony_1.jpg anthony_mask.jpg \
          -composite  anthony_removed.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="anthony_removed.jpg"><img src="anthony_removed.jpg" width="100" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>This can be handy when taking photos of a public monument, where you can't afford the expense of crowd control. Just take lots and lots of photos from a tripod, and hopefully you can combine them to remove everyone from the scene! An alturnative to generating a background image which you have hundredes of images (video) is to just create an average of all the images. This Turn all the people or other transient objects into a light haze of 'ghosts'. That can be an interesting effect in and of itself, but not always what is wanted. An average image can be an useful step, as once you have it you can compare it against each individual image to mask out the person (transient object) from each frame, before again combining the backgrounds together, to create a clean (no haze) background image). A major discussion on automatically generating a 'clean background' from video images is in IM Discussion Forum on <a href="../forum_link.cgi?t=29245">Creating a Referance Image</a> and <a href="../forum_link.cgi?t=29233">Extracting change events</a>.<br>
          With a clean background photo, we we can threshold a difference image to mask out the parts of the image that changed. You may need to use some further blurring and threshold to expand that mask appropriately to cover not only the object within the image, but any shadows or reflections it may cast on the background scenery. A little trial and error may also be needed to get it right.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick anthony_removed.jpg anthony_2.jpg \
          -compose difference -composite \
          -threshold 5% -blur 0x3 -threshold 20% -blur 0x3 \
          anthony_automask.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="anthony_automask.jpg"><img src="anthony_automask.jpg" width="100" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>Now lets use this mask to mix my 'ghosts' image with the original image so it looks like my conscience is 'haunting' me for making such 'impossible' pictures.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick anthony_1.jpg anthony_ghosts.jpg anthony_mask.jpg \
          -composite  anthony_haunted.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="anthony_haunted.jpg"><img src="anthony_haunted.jpg" width="100" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>As a final point, all the above techniques assumes the photos were taken from a camera that was locked down securely on a stationary tripod. If this was not the case, but just taken from a hand held position, I can guarantee that the images will not match-up or 'align' properly, no matter how hard you tried to do it. In such cases you may require some <a href="../distorts/#affine">Affine</a> or even <a href="../distorts/#perspective">Perspective</a> distortion of at least one of the two images to get the backgrounds to align properly. The more complex the background, the more exacting the needed re-alignment. If a flash was used, or the day was cloudy with variable light, you may also need some brightness adjustments to the photo. The cause is that most cameras 'auto-adjust' the brightness of the images, and a flash, or variable light can change its handling of the 'auto-level' adjustment for each and every image. As a final example, here is another image I created from two separate photos, of my nephew fencing with himself, in front of a climbing wall. As I was holding the camera and used a flash, I did need to do some affine distortion adjustments, as well as slight brightness adjustment to get the seamless result you see.
          <div align="center">
            <a href="../img_photos/jacob_vs_jacob_md.jpg"><img src="../img_photos/jacob_vs_jacob_md.jpg" width="600" height="400" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a><br>
            <b><i>Jacob</i> vs <i>Jacob</i></b>
          </div>If you were trying to decide if this photo was fake or not, you would look at the lighting, shadows and reflections. In the above, a close examination of the floor will show that the right 'Jacob' does not have a proper reflection on the floor (it was clipped by the photos edge). But you would really need to study the photo well to notice this! Now think of the possibilities you can use this 'double exposure' technique for. For example how about some <a href="http://todaypictures.blogspot.com/2006/03/funny-mirror.html">Funny Mirrors</a>. Email me your results! If you like to get into this further the research paper "<a href="http://grail.cs.washington.edu/projects/photomontage/photomontage.pdf">Interactive Digital Photomontage</a>", goes into using "Double Exposures" (or as it terms it "photo montage"), but making use of user selections expanded using "image segmentation", to select what parts of the image is to come from where. One example is if you have a number of photos of a large group of people, in each photo someone does not 'look good'. You can use this technique to select which person comes from which image so that you can get a perfect group photo where everyone is: facing front, with eyes open, and smiling!<br>
          <a name="anonymity" id="anonymity"></a>
          <h3>Protect Someone's Anonymity <font size="-1">-- fuzzing out some part of a photo</font></h3>The above technique of using a 3 image composite mask can also be used in other ways. For example you can 'pixelate' and image, then use a mask to limit the effect to just the face of a person, so as to "Protect their Identity".
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick zelda_tn.gif -scale 25%  -scale 400%  zelda_pixelate.gif
  magick zelda_tn.gif -gamma 0 -fill white \
          -draw 'circle 65,53 50,40'   zelda_face_mask.gif
  magick zelda_tn.gif zelda_pixelate.gif zelda_face_mask.gif \
          -composite   zelda_anonymity.png
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/zelda_tn.gif"><img src="../img_photos/zelda_tn.gif" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="zelda_pixelate.gif"><img src="zelda_pixelate.gif" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <a href="zelda_face_mask.gif"><img src="zelda_face_mask.gif" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="zelda_anonymity.png"><img src="zelda_anonymity.png" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>Of course you can do this all in one go, and even smooth the change from pixelated to normal. For example..
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr>
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick zelda_tn.gif \( +clone -scale 25%  -scale 400% \) \
          \( +clone -gamma 0 -fill white \
             -draw 'circle 65,53 50,40' -blur  10x4 \) \
          -composite  zelda_anonymity.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="zelda_anonymity.jpg"><img src="zelda_anonymity.jpg" width="120" height="90" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>Of course rather than pixelate the offending part, you can also blur the area instead. Just replace the two "<code><a href="../option_link.cgi?scale">-scale</a></code>" operators with a single "<code><a href="../option_link.cgi?blur">-blur</a></code>" to fuzz out the details. This technique replacing a masked area can also be used to remove unwanted text and logos from images. For details see <a href="../masking/#hole_filling">Hole Filling</a>. <a name="texture" id="texture"></a>
          <h3>Add a Texture to an Image</h3>The <a href="../compose/#hardlight">Hardlight</a> alpha compositing method or even any of the various <a href="../compose/#light">Lighting Composition Methods</a> provide ways to give an image a texture pattern. For example, here I add a texture of course fabric to a photo I took of a pagoda at the Kunming Zoo, in southern China.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick tile_fabric.gif -colorspace gray  -normalize \
          -fill gray50 +level 35%      texture_fabric.gif
  magick composite texture_fabric.gif  pagoda_sm.jpg \
            -tile   -compose Hardlight    photo_texture.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="../images/tile_fabric.gif"><img src="../images/tile_fabric.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="texture_fabric.gif"><img src="texture_fabric.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="photo_texture.jpg"><img src="photo_texture.jpg" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>Note that if you want to actually <i>tile</i> the texture over the image you need to use the "<code>magick composite</code>" command rather than the more versatile "<code>magick</code>" command, though there are a number of other ways to <a href="../canvas/#tile_memory">Tile Images in Memory</a> using convert. Also note that when adding a texture like this, the smaller details in the original photo can be lost by excess noise of the overlaid texture, textures should ge hept either simple, or their effect appropriatally moderated, such as the <a href="../color_mods/#level_plus">Decontrasting Level Adjustment</a> used above. To use an image pattern as a texture it should be modified so that a perfect gray color is used for areas that is unchanged in the original image. That is the average color of the image should be about 50% gray. In the example I demonstrate one way that you can do this with just about any tileable image, though this specific method may not always work well. Such textures can be found all over the web, as various background patterns for web pages. They may not even look like a texture, be colorful, or even very bright or very dark. After adjustment however you will find that you can get some very interesting effects. Just as we did previously, you can limit what parts of an image is actually textured by creating an appropriate mask. For example lets create a mask of just the near 'white' sky in the pagoda photo.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick pagoda_sm.jpg -fuzz 10% -transparent white \
          -alpha extract -negate  pagoda_mask.png
  magick pagoda_sm.jpg  photo_texture.jpg  pagoda_mask.png \
          -composite  photo_texture_masked.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="pagoda_mask.png"><img src="pagoda_mask.png" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="photo_texture_masked.jpg"><img src="photo_texture_masked.jpg" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>Now imagine an picture of a lady wearing a dress. You can get any pattern shade it appropriately, and then overlay that on the original image so as to replace the dress with a completely different design. Of course there are lots of variations on the above to achieve the final result, and which specific technique you use is up to you, but the basic idea is the same. Texture the image, mask and overlay the result. As an aside, I also recommend you look at the <a href="../compose/#overlay">Overlay</a> alpha composing method, which is simply the same as <a href="../compose/#hardlight">Hard_Light</a> composition, but with the two images swapped. There is also a lot of other <a href="../compose/#shade">Shading Composition Methods</a> that can be used to texture an image in various ways.<br>
          <a href="../img_photos/shirt.jpg"><img src="../img_photos/shirt.jpg" width="188" heigh="300" align="right" vspace="0" hspace="5" border="1" alt="[IM Output]"></a> <a name="chroma_key" id="chroma_key"></a>
          <h3>Chroma Key Masking <font size="-1">-- Modifying by areas of specific color</font></h3>The photo to the left was given by an user in a <a href="../forum_link.cgi?t=18094">IM Forum Discussion</a>. he wanted to change the color of the girls shirt, which was a nice 'pink' color. The problem is the color is not just 'pink' but a whole range of different shades of 'pink'. As you have seen above, to make changed to an image, the first step is typically generating an appropriate mask of the area you are interested in. Here I will use a technique known as <a href="http://en.wikipedia.org/wiki/Chroma_key">Chroma Key</a> to generate mask that specific color. This technique generally looks for a specific color in an image for use as the mask. It is also the technique used for 'blue' and 'green' screen effects used extensively on TV and in Movies.<br>
          &nbsp;<br>
          This basically involves extracting the 'Hue' by <a href="../color_basics/#separate">Separating Channel Images</a>, then looking up the 'hue shade' wanted. For example...<br clear="all">
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick shirt.jpg -colorspace HSL -channel Hue -separate shirt_hue.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>However this Hue image has a couple of problems.
                <ul>
                  <li>First a 'pink' color is very close to 'red' which is at the division where Hue 'rolls over'. To ensure this is not a problem I use <a href="../color_mods/#modulate">Modulate</a> to adjust the hue away from that 'discontinuity' in the hue. This is not a problem for extracting a 'chroma key' for 'green' or 'blue' screens.
                  </li>
                  <li>This 'pink' color is also not a highly saturated color, but has a very low saturation value. This means its 'hue' is not as strong as it should be.</li>
                  <li>The other problem is the gray background!!!!! Gray is has very little hue, so I need to remove any areas with little to no saturation from my final mask, or I'll be changing things in the background. Note that this is technically not needed if I limit changes to hue rolls, which does not effect unsaturated colors.</li>
                </ul>In short, the input image would have worked better with a brighter stronger color that was also not as simial to skin (or hair) color. A strong blue or green shirt for example. But I will work with what I was given.
              </td>
              <td>
                <a href="shirt_hue.jpg"><img src="shirt_hue.jpg" width="188" heigh="300" align="middle" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                So lest extract and combine the two channel masks. Note that Hue = Gray64 after the image hues was 'rolled' using module, and Saturated = Black for the grey background.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick shirt.jpg -modulate 100,100,33.3  -colorspace HSL \
          -channel Hue,Saturation -separate +channel \
          \( -clone 0 -background none -fuzz 5% +transparent grey64 \) \
          \( -clone 1 -background none -fuzz 10% -transparent black \) \
          -delete 0,1  -alpha extract  -compose multiply -composite \
          shirt_mask.png
</samp></pre>
                    </td>
                  </tr>
                </table>That just leaves a number of small isolated 'specks' that can be removed with some <a href="../morphology/#smooth">Morphology Smoothing</a> (<code>-morphology Smooth Square</code>). It isn't perfect but it will do the job. The better way would be to edit the mask by hand to clean it up. Now a mask can be used with <a href="../compose/#mask">Composite Masking</a> much like we did with <a href="#double">Double Exposures</a> and <a href="#anonymity">Anonymity</a> examples above. However If you are using a mask to modify an existing image (without distorting, or changing the images size), then it is easier to use it to define what areas are un-writable. These are known as <a href="../masking/#clip-mask">Clip or Write Masks</a> (see "<code><a href="../option_link.cgi?-mask">-mask</a></code>"
              </td>
              <td>
                <a href="shirt_mask.png"><img src="shirt_mask.png" width="188" heigh="300" align="middle" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="top">
              <td width="100%" align="justify">
                Here I cleanup the previous mask of the small defects (optional), and negate it to define what areas I want to 'write protect'. Then I set this mask, shift the hues to turn 'pink' into a 'light blue' color, and save the resulting image.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
  magick shirt_mask.png -morphology Smooth Square \
          -negate   shirt_write_mask.png

  magick shirt.jpg  -mask shirt_write_mask.png \
          -modulate 100,100,25     +mask shirt_blue.jpg
</samp></pre>
                    </td>
                  </tr>
                </table>Yes there is a slight 'pink' border, especially in the inside sleeve. Also a small area of skin on her arm turned a rather dark blue. Basically these are mask defects, and with a little more work in perfecting the mask you can fix these problems. But it is not bad result. One method of generating a better mask is to use a much larger higher resolution image. When the resulting image is later resized these small defects will (hopefully) also be reduced to insignificance.
              </td>
              <td>
                <a href="shirt_blue.jpg"><img src="shirt_blue.jpg" width="188" heigh="300" align="right" vspace="0" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>The real problem with this specific example, is the 'key color' is so close to a normal skin color you are really just asking for trouble! This is why people using this technique use 'green' and 'blue' screens, as those colors are as different as possible from 'skin' color of people in front of the screen. Note that you are better off NOT using JPEG as your source or working images. Really JPEG should only be used for your final images only! This is part of the reason why so many 'mask defects' was generated in the first place. <a name="green_screen" id="green_screen"></a>
          <h3>Green Screen</h3><i>Future example, using Chroma Key Masking of a 'green screen background'. Expanded from the wikipedia artical, <a href="http://en.wikipedia.org/wiki/Chroma_key">Chroma Key</a><br>
          <br>
          Real problems in 'green screen' handling is the 'color spill', with fine light color hair (blonde) and semi-transparent areas producing the worse color spill effects.<br>
          <br>
          Simplistic Colorspill removal (color fix)</i>
          <div align="center">
            <i><code>g(r,g,b) =&gt; (r, min(g, b), b)</code></i>
          </div><i>Alpha determination...</i>
          <div align="center">
            <i><code>a(r,b,g) =&gt; K0 * b − K1 * g + K2</code></i>
          </div><i>Using values of 1.0 for all K coefficients is good initial guess.<br>
          <br>
          As the Background color is well known, and once the 'alpha' is known you can use techniques shown in <a href="../masking/#two_background">Background Removal using Two Backgrounds</a> to remove any 'green screen halo' that may be present better that the first color formula.<br>
          <br></i><br>
          <a name="charcoal" id="charcoal"></a>
          <h3>Artist Charcoal Sketch of Image</h3>The <a href="../transform/#charcoal">Charcoal Sketch Transform</a>, offers users a very simple way of generating a simplified gray-scale rendering of the image. It does not work well for 'busy images' but for simpler images it can produce a very striking result.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
     magick holocaust_sm.jpg -charcoal 5 charcoal.gif
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/holocaust_sm.jpg"><img src="../img_photos/holocaust_sm.jpg" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="charcoal.gif"><img src="charcoal.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div><a name="color-in" id="color-in"></a>
          <h3>Children's Color-In Outline Image</h3>In a long discussion about <a href="../forum_link?t=6974">Generating Coloring-In Pages</a> on the IM Users Forum, the following cookbook recipe was developed to magick a simple photo into something children can color in. Here is the best result we have so far, applied to a photo I took of the holocaust memorial, Berlin.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick holocaust_sm.jpg \
          -edge 1 -negate -normalize \
          -colorspace Gray -blur 0x.5 -contrast-stretch 0x50% \
          color-in.gif
  # For heavily shaded pictures...
  #     #-segment 1x1 +dither -colors 2 -edge 1 -negate -normalize \
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/holocaust_sm.jpg"><img src="../img_photos/holocaust_sm.jpg" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="color-in.gif"><img src="color-in.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>The final operations in the above attempt to smooth out the lines and improve the overall result. Of course the above technique is only useful for images with good sharp color changes, and preferably a higher resolution image than I used above. For cartoon images that already have black outlines with a light colored background, the use of <a href="../transform/#edge">Edge Detection</a> with the above method will directly produce a 'twinning' effect of the black outlines. You can see this effect in the twinned lines of tiles on the path leading into the memorial, in the lower-left corner. This is an artifact of the way <a href="../transform/#edge">Edge Detection</a> works, and you can see more examples of this in that section of IM Examples. The solution is to negate images of this type before using "<code><a href="../option_link.cgi?edge">-edge</a></code>" to outline the colored areas.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick piglet.gif -background white -flatten \
          -colorspace Gray -negate -edge 1 -negate -normalize \
          -threshold 50% -despeckle \
          -blur 0x.5 -contrast-stretch 0x50% \
          color-in_cartoon.gif
</samp></pre>
                </td>
              </tr>
            </table><a href="../images/piglet.gif"><img src="../images/piglet.gif" width="100" height="100" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="color-in_cartoon.gif"><img src="color-in_cartoon.gif" width="100" height="100" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>I also "<code><a href="../option_link.cgi?threshold">-threshold</a></code>" so I can then remove individual dots that "<code><a href="../option_link.cgi?edge">-edge</a></code>" seem to like to generate. After that I again attempt to smooth out the aliased lines in the image. The above was added to in a discussion on <a href="../forum_link?t=6974">GIMP Photocopy Filter</a> to make use of the <a href="../compose/#divide">Compose Divide</a> method, to find outlines.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick taj_mahal_sm.png -colorspace gray \
          \( +clone -blur 0x2 \) +swap -compose divide -composite \
          -linear-stretch 5%x0%   photocopy.png
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/taj_mahal_sm.png"><img src="../img_photos/taj_mahal_sm.png" align="middle" vspace="2" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="photocopy.png"><img src="photocopy.png" align="middle" vspace="2" hspace="5" border="1" alt="[IM Output]"></a>
          </div>The "<code><a href="../option_link.cgi?linear-stretch">-linear-stretch</a></code>" operation in the above adjusts how black the dark areas of the images will be, while the "<code><a href="../option_link.cgi?blur">-blur</a></code>" 'sigma' defines the shading sharpness. <a name="pencil" id="pencil"></a>
          <h3>Pencil Sketch</h3>Using a <a href="http://www.state-of-entropy.com/">Photoshop (PSP) tutorial</a> on converting images to <a href="http://www.state-of-entropy.com/sketching.htm">Pencil Sketches</a>, <i><a href="../forum_link.cgi?u=3441">dognose</a></i> from the <a href="../forum_link.cgi?f=1">IM Users Forum</a>, managed to create the equivalent ImageMagick commands. Here is his conversion, simplified into a few IM commands, allowing you to batch process lots of images into a 'artists pencil sketch' form. First we need a special "<code>pencil.gif</code>" image. This can take a long time, so for this example I made it a bit smaller, while preserving its ability to be tiled across larger images. See <a href="../canvas/#tile_mod">Modifying Tile Images</a> for details of the techniques.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="bottom">
              <td width="100%" align="justify">
                This only needs to be done once and can then be re-used. As such you can generate a much larger one for your own use, so as to avoid any tiling effects. Ideally make it as large as the images you plan to convert.
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre class="bg-light text-dark mx-4"><samp>
<br>  magick -size 256x256 xc:  +noise Random  -virtual-pixel tile \
             -motion-blur 0x20+135 -charcoal 1 -resize 50% pencil_tile.gif
</samp></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="pencil_tile.gif"><img src="pencil_tile.gif" width="128" height="128" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
              </td>
            </tr>
          </table>Now it is only a matter of overlaying and blending this 'pencil' shading image with a photo. The pencil image is tiled to make a canvas the same size as the image we are processing. Then it is applied to the image using techniques found in <a href="../canvas/#tile">Tiled Canvases</a>. This is then merged into a gray-scaled copy of the original image.
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
     magick pagoda_sm.jpg -colorspace gray \
          \( +clone -tile pencil_tile.gif -draw "color 0,0 reset" \
             +clone +swap -compose color_dodge -composite \) \
          -fx 'u*.2+v*.8' sketch.gif
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/pagoda_sm.jpg"><img src="../img_photos/pagoda_sm.jpg" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="sketch.gif"><img src="sketch.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div>Note that as the "<code><a href="../option_link.cgi?blend">-blend</a></code>" operator of the "<code><a href="../basics/#composite">composite</a></code>" command is not available to the "<code>magick</code>" command, I opted to do the equivalent using the DIY "<code><a href="../option_link.cgi?fx">-fx</a></code>" operator. There are probably better, faster but more complicated ways of doing this. (suggestions are welcome) This is not the final version, as the operator misses some edge enhancement aspects needed for outline some of the more lighter but sharp color changes in the image. Can you improve the above? The above algorithm was built into IM as an artistic transform "<code><a href="../option_link.cgi?sketch">-sketch</a></code>", though without the "<code><a href="../option_link.cgi?resize">-resize</a></code>" smoothing for the generated 'pencil tile'...
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
<br>  magick pagoda_sm.jpg -colorspace gray -sketch 0x20+120 sketch_new.gif
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/pagoda_sm.jpg"><img src="../img_photos/pagoda_sm.jpg" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a> <img src="../img_www/right.gif" align="middle" width="20" height="20" alt="==&gt;"> <a href="sketch_new.gif"><img src="sketch_new.gif" align="middle" vspace="5" hspace="5" border="1" alt="[IM Output]"></a>
          </div><a name="vignettation" id="vignettation">
          <h3>Vignette Removal</h3></a> When taking photos (digital or otherwise, the camera lens generally darkens the edges and corners of the image. This is called 'vignetting'. In fact this lens effect is so common, it is often faked on purpose using the "<code><a href="../option_link.cgi?vignette">-vignette</a></code>" operator. See the <a href="../transform/#vignette">Vignette Transform</a>. Martin Herrmann &lt;Martin-Herrmann@gmx.de&gt; wanted to remove camera vignetting from the photos. Basically he took a photo of a white sheet of paper in a bright light without using a flash. He then wanted to combine this with his actual photos to brighten the edges and corners of the image appropriately. Basically what we want to do is divide the original photo by the grey-scale image of the photo of the brightly lit white piece of paper and it will then brighten the parts of the image by the amount that the 'white paper' photo was darkened. This is basically the compose method '<code><a href="../compose/#divide">Divide</a></code>' which divides the 'source' image by the 'background' image. For example,
          <div align="center">
            <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="90%" bgcolor="#F8F8F8">
              <tr>
                <td>
                  <pre class="bg-light text-dark mx-4"><samp>
  magick nikon18-70dx_18mm_f3.5.jpg  vegas_orig.jpg \
          -compose Divide -composite  vegas_fixed.jpg
</samp></pre>
                </td>
              </tr>
            </table><a href="../img_photos/vegas_orig.jpg"><img src="../img_photos/vegas_tn.gif" width="105" height="70" align="middle" vspace="2" hspace="5" alt="[photo]"></a> <img src="../img_www/plus.gif" width="20" height="20" align="middle" alt=" + "> <a href="../img_photos/nikon18-70dx_18mm_f3.5.jpg"><img src="../img_photos/nikon18-70dx_18mm_f3.5.gif" width="105" height="70" align="middle" vspace="2" hspace="5" alt="[photo]"></a> <img src="../img_www/right.gif" width="20" height="20" align="middle" alt="==&gt;"> <a href="vegas_fixed.jpg"><img src="vegas_fixed.gif" width="105" height="70" align="middle" vspace="2" hspace="5" alt="[photo]"></a><br>
            (click to see larger photo image)
          </div><!-- <CODE EXECUTE>
   magick vegas_fixed.jpg -thumbnail 105x70 +repage vegas_fixed.gif
</CODE> -->
          However as the photo of the 'white paper' will probably not be a true white, and you probably do not want to brighten the image by this 'off-white' color. To fix this we need to multiply the divisor image by its the center pixel color. Here is the final solution provided to Martin, which used the very slow <a href="../transform/#fx">FX DIY Operator</a>. This pre-dated the addition of a <a href="../compose/#divide">Divise Compose Method</a> which can be used to speed up this process enormously. The white photo was also grey scaled to remove any color distortion as well, note that I changed the ordering which will also preserve any 'meta-data' that was in the original (as it is the 'destination' image in this case.
          <table border="0" cellspacing="0" cellpadding="0" width="100%">
            <tr valign="bottom">
              <td width="100%" align="justify">
                <table class="table table-sm table-hover table-striped" cellspacing="0" cellpadding="5" width="100%" bgcolor="#F8F8F8">
                  <tr>
                    <td>
                      <pre><code do_not_execute_linked_from_photo_store="">
  magick vegas_orig.jpg \( nikon18-70dx_18mm_f3.5.jpg -colorspace Gray \) \
          -fx '(u/v)*v.p{w/2,h/2}'   vegas_fixed_fx.jpg
</code></pre>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <a href="../img_photos/vegas_fixed_fx.jpg"><img src="../img_photos/vegas_fixed_fx.gif" width="105" height="70" align="middle" vspace="2" hspace="5" alt="[photo]"></a>
              </td>
            </tr>
          </table><!-- <CODE DO_NOT_EXECUTE_linked_from_photo_store>
   magick vegas_fixed_fx.jpg -thumbnail 105x70 +repage vegas_fixed_fx.gif
</CODE> -->
          If you look carefully at the enlarged photos, particularly the top-left and top-right 'sky' corners, you can see the vignetting effects, and the correction that was made. It is not a perfect solution, and could use a little more tweaking. For example rather than using a scaling pixel, we could pre-process the 'white page' image, and also adjust it for a better vignette removal result. Note that using JPEG is not recommended for any sort of photographic work, as the format can introduce some artifacts and inconsistencies in the results. The format is only good for storage and display of the final results. A major discussion on correcting vignettation is in the IM User Forums in the discussion <a href="../forum_link.cgi?f=1&amp;t=18944">Algorithmic vignetting correction for pinhole cameras?</a>. Things that can effect vignettation include...
          <ul>
            <li>Distance of film from lens, further away means more light spread.</li>
            <li>Area of the aperture 'circle' (lens or pinhole) due to angle of light.</li>
            <li>Arrangement of camera material around the aperture. For example the lens holder or pinhole thickness.</li>
          </ul>
        </div>
        <hr>
        <!-- ---------------------------------------------------------------- -->
      </div>
    </div>
  </main>
  <footer class="magick-footer">
    <div class="container-fluid">
      Created: 21 July 2006<br>
      Updated: 16 June 2011<br>
      Author: <a href="https://antofthy.gitlab.io/anthony.html">Anthony Thyssen</a>, &lt;Anthony.Thyssen@gmail.com&gt;<br>
      Examples Generated with: <img src="version.gif" align="absmiddle" alt="[version image]"><br>
      URL: <code>https://imagemagick.org/Usage/photos/</code>
    </div>
  </footer>
</body>
</html>
